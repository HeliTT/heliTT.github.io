<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jaksotuspohja – opiskelijan aikatauluttaja</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Libraries for export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>Jaksotuspohja – opiskelijan aikatauluttaja</h1>
    <div class="controls">
      <label>
        Opiskelijan nimi
        <input id="studentName" type="text" placeholder="Etunimi Sukunimi" />
      </label>
      <button class="btn" id="clearBtn" title="Palauta palikat palettiin">Tyhjennä sijoittelut</button>
      <button class="btn" id="resetAllBtn" title="Poistaa myös tallennetut tiedot">Nollaa kaikki</button>
      <button class="btn" id="printBtn" title="Tulosta / tallenna PDF">Tulosta</button>
      <button class="btn primary" id="downloadPdfBtn">Lataa PDF</button>
    </div>
  </header>

  <main>
    <section class="palette">
      <h2>Kurssit</h2>
      <div class="legend">Raahaa kurssit oikeaan suoritusajankohtaan.</div>
      <div id="blockList" class="block-list" aria-label="Palettipalikat">
        <!-- 20 blocks injected -->
      </div>
      <div class="footer-note">Tallennus: selaimen <strong>localStorage</strong> (laite- & selainkohtainen). ”Tyhjennä sijoittelut” palauttaa palikat palettiin.</div>
    </section>

    <section class="canvas">
      <h2>Jaksot</h2>
          <div id="captureArea" class="grid-wrap">
        <table class="grid" role="grid" aria-label="Jaksoruudukko">
          <thead>
            <tr>
              <th class="col-head" data-col="1">Jakso 1</th>
              <th class="col-head" data-col="2">Jakso 2</th>
              <th class="col-head" data-col="3">Jakso 3</th>
              <th class="col-head" data-col="4">Jakso 4</th>
              <th class="col-head" data-col="5">Jakso 5</th>
              <th class="col-head" data-col="6">Jakso 6</th>
            </tr>
          </thead>
          <tbody id="gridBody">
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'jaksotuspohja.v2';

    const blockList = document.getElementById('blockList');
    const gridBody = document.getElementById('gridBody');
    const studentNameInput = document.getElementById('studentName');

    function saveState() {
      const state = { blocks: [], studentName: studentNameInput.value };
      document.querySelectorAll('.block').forEach(b => {
        const dz = b.parentElement.closest('.dropzone');
        state.blocks.push({
          id: b.dataset.blockId,
          containerId: dz ? dz.id : 'palette'
        });
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }

    const blockNames = ["Asiakaspalvelu", "Asiakaspalvelun englanti", "Asiakaspalvelun ruotsi",
     "Asiakaspalvelun suomi", "Liiketoimintaan perehtyminen", "Työyhteisö", "Digitaalinen työympäristö",
    "Toiminnan kannattavuus", "YTO viestintä suomi", "YTO englanti", "YTO ruotsi", "YTO toiminta digitaalisessa ympäristössä", 
    "YTO taide ja luova ilmaisu" , "YTO matematiikka", "YTO fysiikka ja kemia", "YTO Yhteiskunnassa ja kansalaisena toimiminen"]


    function makeBlock(id) {
      const el = document.createElement('div');
      el.className = 'block';
      el.draggable = true;
      el.dataset.blockId = id;
      el.textContent = blockNames[id-1] || `Palikka ${id}`;
      // Ei tekstin eikä värin muokkausta -> ei contenteditablea, ei dblclick-värinvaihtoa

      el.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', el.dataset.blockId);
        setTimeout(() => el.style.opacity = '0.6', 0);
      });
      el.addEventListener('dragend', () => { el.style.opacity = '1'; saveState(); });

      return el;
    }

    function makeDropzone(id) {
      const dz = document.createElement('div');
      dz.className = 'dropzone';
      dz.id = id;
      dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('drag-over'); });
      dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
      dz.addEventListener('drop', (e) => {
        e.preventDefault(); dz.classList.remove('drag-over');
        const id = e.dataTransfer.getData('text/plain');
        const block = document.querySelector(`[data-block-id="${CSS.escape(id)}"]`);
        if (block) dz.appendChild(block);
        saveState();
      });
      return dz;
    }

    // Rakenna 10 riviä × 6 jaksoa (otsikot ei-muokattavia)
    for (let r = 1; r <= 10; r++) {
      const tr = document.createElement('tr');
    

      for (let c = 1; c <= 6; c++) {
        const td = document.createElement('td'); td.className = 'cell';
        td.appendChild(makeDropzone(`cell-r${r}-c${c}`));
        tr.appendChild(td);
      }
      gridBody.appendChild(tr);
    }

    // Paletti droppaus paluuta varten
    blockList.addEventListener('dragover', (e) => { e.preventDefault(); blockList.classList.add('drag-over'); });
    blockList.addEventListener('dragleave', () => blockList.classList.remove('drag-over'));
    blockList.addEventListener('drop', (e) => {
      e.preventDefault(); blockList.classList.remove('drag-over');
      const id = e.dataTransfer.getData('text/plain');
      const block = document.querySelector(`[data-block-id="${CSS.escape(id)}"]`);
      if (block) blockList.appendChild(block);
      saveState();
    });

    // Luo 20 palikkaa
    for (let i = 1; i <= 20; i++) blockList.appendChild(makeBlock(i));

    // Palauta tallennettu tila (vain sijoittelut + nimi)
    (function restore() {
      const s = loadState();
      if (!s) return;
      if (s.studentName) studentNameInput.value = s.studentName;
      if (Array.isArray(s.blocks)) {
        s.blocks.forEach(b => {
          const el = document.querySelector(`.block[data-block-id="${CSS.escape(b.id)}"]`);
          if (!el) return;
          if (b.containerId && b.containerId !== 'palette') {
            const dz = document.getElementById(b.containerId);
            if (dz) dz.appendChild(el);
          } else {
            blockList.appendChild(el);
          }
        });
      }
    })();

    // Tallenna nimi muutoksesta
    studentNameInput.addEventListener('input', saveState);

    // Tyhjennä sijoittelut = siirrä palikat palettiin
    document.getElementById('clearBtn').addEventListener('click', () => {
      document.querySelectorAll('.block').forEach(b => blockList.appendChild(b));
      saveState();
    });

    // Nollaa kaikki = poista localStorage ja palauta perusnäkymä
    document.getElementById('resetAllBtn').addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY);
      studentNameInput.value = '';
      document.querySelectorAll('.block').forEach((b,i) => { blockList.appendChild(b); });
    });

    // Tulostus & PDF
    document.getElementById('printBtn').addEventListener('click', () => window.print());

    async function generatePdfBlob() {
      const name = (studentNameInput.value || '').trim();
      const banner = document.createElement('div');
      banner.className = 'pdf-banner';
      banner.textContent = name ? `Opiskelija: ${name}` : 'Opiskelija: (nimi)';
      const captureArea = document.getElementById('captureArea');
      captureArea.prepend(banner);
      await new Promise(r => requestAnimationFrame(r));
      const canvas = await html2canvas(captureArea, { scale: 2, backgroundColor: '#ffffff' });
      banner.remove();
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
      const w = canvas.width * ratio;
      const h = canvas.height * ratio;
      const x = (pageWidth - w) / 2; const y = (pageHeight - h) / 2;
      pdf.addImage(imgData, 'PNG', x, y, w, h);
      return pdf.output('blob');
    }

    document.getElementById('downloadPdfBtn').addEventListener('click', async () => {
      const btn = document.getElementById('downloadPdfBtn');
      btn.disabled = true; btn.textContent = 'Luodaan PDF…';
      try {
        const blob = await generatePdfBlob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const name = (studentNameInput.value || 'jaksotuspohja').replace(/\s+/g,'_');
        a.href = url; a.download = `${name}.pdf`; a.click();
        URL.revokeObjectURL(url);
      } catch (e) { alert('PDF:n luonti epäonnistui. Yritä uudelleen.'); console.error(e); }
      finally { btn.disabled = false; btn.textContent = 'Lataa PDF'; }
    });
  </script>
</body>
</html>
